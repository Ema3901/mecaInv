<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos Ocupados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />
  <style>
    .badge-prof {
      background-color: var(--primary-green, #2fa46e);
      color: white;
      padding: 0.4em 0.7em;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .badge-student {
      background-color: #6f42c1;
      color: white;
      padding: 0.3em 0.6em;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .table-loading {
      text-align: center;
      padding: 3rem 0;
      color: #6c757d;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2fa46e;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .table-error {
      text-align: center;
      padding: 3rem 0;
      color: #dc3545;
    }
    
    .return-btn {
      transition: all 0.3s ease;
    }
    
    .return-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .no-borrows-message {
      text-align: center;
      padding: 4rem 2rem;
      background: #f8f9fa;
      border-radius: 15px;
      margin: 2rem 0;
    }
    
    .no-borrows-message i {
      font-size: 4rem;
      color: #28a745;
      margin-bottom: 1.5rem;
    }
    
    .borrow-info {
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .days-borrowed {
      font-weight: bold;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        Inventario
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="index.html"><i class="fas fa-cubes"></i> Inventario</a></li>
          <li><a href="deleteItems.html"><i class="fas fa-archive"></i> Desactivados</a></li>
          <li><a href="pendientesCheck.html"><i class="fas fa-exclamation-circle"></i> Pendientes Check</a></li>
          <li><a href="historial.html"><i class="fas fa-history"></i> Historial</a></li>
          <li><a href="productosOcupados.html" class="active"><i class="fas fa-user-clock"></i> Ocupados</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="main-header d-flex align-items-center justify-content-between flex-wrap">
        <h1>Productos prestados</h1>
        <div class="user-box dropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="img/stock.jpg" alt="User Avatar" id="profileDropdown"/>
          <span>Ann Lee</span>
          <i class="fas fa-chevron-down ml-2"></i>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
            <li><a class="dropdown-item" href="login.html" onclick="handleLogout()">Cerrar sesión</a></li>
          </ul>
        </div>
      </header>

      <div class="divider"></div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-clock text-warning fs-2 mb-2"></i>
              <h5 class="card-title">Total Prestados</h5>
              <h3 class="text-primary mb-0" id="totalPrestados">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-exclamation-triangle text-danger fs-2 mb-2"></i>
              <h5 class="card-title">Más de 7 días</h5>
              <h3 class="text-danger mb-0" id="prestamosVencidos">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-users text-info fs-2 mb-2"></i>
              <h5 class="card-title">Estudiantes</h5>
              <h3 class="text-info mb-0" id="totalEstudiantes">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-chalkboard-teacher text-success fs-2 mb-2"></i>
              <h5 class="card-title">Profesores</h5>
              <h3 class="text-success mb-0" id="totalProfesores">-</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="row mb-3">
        <div class="col-md-6">
          <button class="btn btn-primary" onclick="cargarPrestamos()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
          <button class="btn btn-success ms-2" onclick="exportarDatos()">
            <i class="fas fa-download"></i> Exportar
          </button>
        </div>
        <div class="col-md-6 text-end">
          <div class="input-group" style="max-width: 300px; margin-left: auto;">
            <input type="text" class="form-control" placeholder="Buscar..." id="searchInput">
            <button class="btn btn-outline-secondary" type="button" onclick="filtrarTabla()">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="table-loading">
        <div class="loading-spinner"></div>
        <h5>Cargando productos prestados...</h5>
        <p>Obteniendo información de la base de datos</p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="table-error" style="display: none;">
        <i class="fas fa-exclamation-triangle mb-3" style="font-size: 3rem;"></i>
        <h4>Error al cargar los datos</h4>
        <p id="errorMessage">Hubo un problema al conectar con el servidor</p>
        <button class="btn btn-primary" onclick="cargarPrestamos()">
          <i class="fas fa-retry"></i> Intentar nuevamente
        </button>
      </div>

      <!-- Table Container -->
      <div class="table-container mt-3" id="tableContainer" style="display: none;">
        <table id="ocupadosTable" class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID Préstamo</th>
              <th>Artículo</th>
              <th>Profesor</th>
              <th>Estudiante</th>
              <th>Matrícula</th>
              <th>Fecha de préstamo</th>
              <th>Días transcurridos</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="borrowsTableBody">
            <!-- Llenado por JS -->
          </tbody>
        </table>
      </div>

      <!-- No Borrows Message -->
      <div id="noBorrowsMessage" class="no-borrows-message" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <h2 class="text-success">¡Todos los productos han sido devueltos!</h2>
        <p class="text-muted">No hay productos prestados actualmente</p>
        <button class="btn btn-primary" onclick="window.location.href='index.html'">
          <i class="fas fa-cubes"></i> Ir al inventario
        </button>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/mobile.js"></script>
  <script src="js/session-manager.js"></script>

  <script>
    // Variables globales
    let borrowedProducts = [];
    let filteredProducts = [];

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      cargarPrestamos();
      
      // Event listener para búsqueda en tiempo real
      document.getElementById('searchInput').addEventListener('input', filtrarTabla);
    });

    // Función principal para cargar préstamos
    async function cargarPrestamos() {
      mostrarEstado('loading');
      
      try {
        console.log('Cargando préstamos desde la API...');
        
        const response = await fetch('https://healtyapi.bsite.net/api/borroweds');
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const allBorrows = await response.json();
        console.log('Todos los préstamos:', allBorrows);
        
        // Filtrar solo préstamos activos (sin return_date)
        borrowedProducts = allBorrows.filter(borrow => !borrow.return_date);
        console.log('Préstamos activos:', borrowedProducts);
        
        if (borrowedProducts.length === 0) {
          mostrarEstado('empty');
        } else {
          mostrarEstado('table');
          actualizarEstadisticas();
          renderizarTabla();
        }
        
      } catch (error) {
        console.error('Error al cargar préstamos:', error);
        mostrarEstado('error', error.message);
      }
    }

    // Función para mostrar diferentes estados
    function mostrarEstado(estado, mensaje = '') {
      const loading = document.getElementById('loadingState');
      const error = document.getElementById('errorState');
      const table = document.getElementById('tableContainer');
      const noData = document.getElementById('noBorrowsMessage');
      
      // Ocultar todos
      loading.style.display = 'none';
      error.style.display = 'none';
      table.style.display = 'none';
      noData.style.display = 'none';
      
      switch(estado) {
        case 'loading':
          loading.style.display = 'block';
          break;
        case 'error':
          error.style.display = 'block';
          if (mensaje) {
            document.getElementById('errorMessage').textContent = mensaje;
          }
          break;
        case 'table':
          table.style.display = 'block';
          break;
        case 'empty':
          noData.style.display = 'block';
          break;
      }
    }

    // Función para actualizar estadísticas
    function actualizarEstadisticas() {
      const total = borrowedProducts.length;
      const hoy = new Date();
      
      let vencidos = 0;
      const estudiantes = new Set();
      const profesores = new Set();
      
      borrowedProducts.forEach(borrow => {
        // Contar días transcurridos
        const fechaPrestamo = new Date(borrow.borrow_date);
        const diasTranscurridos = Math.floor((hoy - fechaPrestamo) / (1000 * 60 * 60 * 24));
        
        if (diasTranscurridos > 7) vencidos++;
        
        if (borrow.Student_name) estudiantes.add(borrow.Student_name);
        if (borrow.UserInfo?.name) profesores.add(borrow.UserInfo.name);
      });
      
      document.getElementById('totalPrestados').textContent = total;
      document.getElementById('prestamosVencidos').textContent = vencidos;
      document.getElementById('totalEstudiantes').textContent = estudiantes.size;
      document.getElementById('totalProfesores').textContent = profesores.size;
    }

    // Función para renderizar la tabla
    function renderizarTabla() {
      const tbody = document.getElementById('borrowsTableBody');
      tbody.innerHTML = '';
      
      const productosAMostrar = filteredProducts.length > 0 ? filteredProducts : borrowedProducts;
      
      productosAMostrar.forEach((borrow) => {
        const tr = document.createElement('tr');
        
        // Calcular días transcurridos
        const fechaPrestamo = new Date(borrow.borrow_date);
        const hoy = new Date();
        const diasTranscurridos = Math.floor((hoy - fechaPrestamo) / (1000 * 60 * 60 * 24));
        
        // Formatear fecha
        const fechaFormateada = fechaPrestamo.toLocaleDateString('es-MX');
        
        // Determinar clase CSS para días transcurridos
        let diasClass = 'text-success';
        if (diasTranscurridos > 7) diasClass = 'text-danger fw-bold';
        else if (diasTranscurridos > 3) diasClass = 'text-warning';
        
        tr.innerHTML = `
          <td><strong>#${borrow.id_borrow}</strong></td>
          <td>
            <strong>${borrow.UnitInfo?.name || 'N/A'}</strong>
            <br><small class="text-muted">S/N: ${borrow.UnitInfo?.serial_number || 'N/A'}</small>
          </td>
          <td><span class="badge-prof">${borrow.UserInfo?.name || 'N/A'}</span></td>
          <td>
            <strong>${borrow.Student_name || 'N/A'}</strong>
            <br><span class="badge-student">${borrow.Student_Grade || ''}${borrow.Student_Group || ''} - ${borrow.Student_Carrer || ''}</span>
          </td>
          <td><code>${borrow.Student_registration || 'N/A'}</code></td>
          <td>
            <strong>${fechaFormateada}</strong>
            <br><small class="borrow-info">${fechaPrestamo.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'})}</small>
          </td>
          <td class="${diasClass}">
            <strong class="days-borrowed">${diasTranscurridos}</strong>
            <br><small>día${diasTranscurridos !== 1 ? 's' : ''}</small>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-success return-btn" 
                    onclick="marcarDevuelto(${borrow.id_borrow}, '${borrow.UnitInfo?.name || 'Producto'}', '${borrow.Student_name || 'Estudiante'}')"
                    title="Marcar como devuelto">
              <i class="fas fa-undo-alt"></i> Devolver
            </button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Función para marcar producto como devuelto
    async function marcarDevuelto(borrowId, productName, studentName) {
      const result = await Swal.fire({
        title: '¿Confirmar devolución?',
        html: `
          <div style="text-align: left;">
            <strong>Producto:</strong> ${productName}<br>
            <strong>Estudiante:</strong> ${studentName}<br><br>
            <small class="text-muted">Esta acción marcará el producto como devuelto y lo liberará para nuevos préstamos.</small>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, marcar como devuelto',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d'
      });

      if (!result.isConfirmed) return;

      // Mostrar loading
      Swal.fire({
        title: 'Procesando devolución...',
        html: 'Actualizando el estado del préstamo',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        // Encontrar el préstamo completo
        const prestamo = borrowedProducts.find(b => b.id_borrow === borrowId);
        if (!prestamo) {
          throw new Error('Préstamo no encontrado');
        }

        // Preparar datos para actualización (PUT)
        const datosActualizacion = {
          id_borrow: prestamo.id_borrow,
          fk_unit: prestamo.UnitInfo?.id_unit,
          fk_user: prestamo.UserInfo?.id_user,
          fk_student: prestamo.fk_student,
          borrow_date: prestamo.borrow_date,
          return_date: new Date().toISOString(),
          status: "devuelto"
        };

        console.log('Actualizando préstamo:', datosActualizacion);

        const response = await fetch('https://healtyapi.bsite.net/api/borroweds', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(datosActualizacion)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }

        Swal.close();

        // Mostrar éxito
        await Swal.fire({
          icon: 'success',
          title: '¡Devolución registrada!',
          html: `El producto <strong>${productName}</strong> ha sido marcado como devuelto.`,
          confirmButtonColor: '#28a745'
        });

        // Recargar datos
        await cargarPrestamos();

      } catch (error) {
        console.error('Error al marcar como devuelto:', error);
        
        Swal.fire({
          icon: 'error',
          title: 'Error al procesar devolución',
          text: error.message,
          confirmButtonColor: '#dc3545'
        });
      }
    }

    // Función para filtrar tabla
    function filtrarTabla() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        filteredProducts = [];
      } else {
        filteredProducts = borrowedProducts.filter(borrow => 
          (borrow.UnitInfo?.name || '').toLowerCase().includes(searchTerm) ||
          (borrow.Student_name || '').toLowerCase().includes(searchTerm) ||
          (borrow.UserInfo?.name || '').toLowerCase().includes(searchTerm) ||
          (borrow.Student_registration || '').toLowerCase().includes(searchTerm) ||
          (borrow.UnitInfo?.serial_number || '').toLowerCase().includes(searchTerm)
        );
      }
      
      renderizarTabla();
    }

    // Función para exportar datos
    function exportarDatos() {
      if (borrowedProducts.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'No hay datos para exportar',
          text: 'No hay productos prestados actualmente',
          confirmButtonColor: '#007bff'
        });
        return;
      }

      // Preparar datos para exportar
      const csvData = borrowedProducts.map(borrow => {
        const fechaPrestamo = new Date(borrow.borrow_date);
        const diasTranscurridos = Math.floor((new Date() - fechaPrestamo) / (1000 * 60 * 60 * 24));
        
        return {
          'ID Préstamo': borrow.id_borrow,
          'Artículo': borrow.UnitInfo?.name || 'N/A',
          'Número de Serie': borrow.UnitInfo?.serial_number || 'N/A',
          'Profesor': borrow.UserInfo?.name || 'N/A',
          'Estudiante': borrow.Student_name || 'N/A',
          'Matrícula': borrow.Student_registration || 'N/A',
          'Carrera': borrow.Student_Carrer || 'N/A',
          'Grado': `${borrow.Student_Grade || ''}${borrow.Student_Group || ''}`,
          'Fecha de Préstamo': fechaPrestamo.toLocaleDateString('es-MX'),
          'Días Transcurridos': diasTranscurridos
        };
      });

      // Convertir a CSV
      const csv = convertToCSV(csvData);
      downloadCSV(csv, `productos_prestados_${new Date().toISOString().split('T')[0]}.csv`);
    }

    // Funciones auxiliares para CSV
    function convertToCSV(data) {
      const header = Object.keys(data[0]).join(',');
      const rows = data.map(row => Object.values(row).join(','));
      return [header, ...rows].join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    console.log('Sistema de productos prestados cargado correctamente');
  </script>
</body>
</html>