<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio de sesión - Inventarios de carrera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="css/login.css" rel="stylesheet" />
  <style>
    /* Estilos para la animación de carga */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Overlay de carga -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Iniciando sesión...</p>
    </div>
  </div>

  <div class="login-container" role="main">
    <section class="login-form" aria-label="Formulario de inicio de sesión">
      <h2>Inicio de sesión</h2>
      <p class="subtitle">Inventarios de carrera</p>

      <button type="button" onclick="window.location.href='index.html'" class="btn-microsoft" aria-label="Iniciar sesión con Microsoft">
        Iniciar sesión con Microsoft
        <span class="microsoft-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="20" height="20">
            <rect width="10" height="10" fill="#F35325"/>
            <rect x="14" width="10" height="10" fill="#81BC06"/>
            <rect y="14" width="10" height="10" fill="#05A6F0"/>
            <rect x="14" y="14" width="10" height="10" fill="#FCDC00"/>
          </svg>
        </span>
      </button>

      <form action="#" method="POST" novalidate id="login-form">
        <label for="email">Correo*</label>
        <input id="email" name="email" type="email" placeholder="Introduce tu correo" required />

        <label for="password">Contraseña*</label>
        <input id="password" name="password" type="password" placeholder="mínimo 8 caracteres" minlength="8" required />

        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="remember" name="remember" />
          <label class="form-check-label" for="remember">Recordarme</label>
        </div>

        <button type="submit" class="btn-login" id="login-btn">
          <span class="btn-text">Iniciar sesión</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Iniciando...
          </span>
        </button>
        <div id="login-error" class="text-danger mt-2" style="display: none;"></div>
      </form>
    </section>

    <section class="login-logo" aria-label="Logo UT Tamaulipas Norte">
      <img src="img/logoUT.png" alt="Logo Universidad Tecnológica Tamaulipas Norte" />
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="js/mobile.js"></script>

<script>
  // Función para mostrar/ocultar la animación de carga
  function toggleLoading(show) {
    const loadingOverlay = document.getElementById("loading-overlay");
    const loginBtn = document.getElementById("login-btn");
    const btnText = loginBtn.querySelector(".btn-text");
    const btnLoading = loginBtn.querySelector(".btn-loading");
    
    if (show) {
      loadingOverlay.style.display = "flex";
      loginBtn.disabled = true;
      btnText.style.display = "none";
      btnLoading.style.display = "inline";
    } else {
      loadingOverlay.style.display = "none";
      loginBtn.disabled = false;
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
    }
  }

  // Función para guardar las credenciales si "Recordarme" está marcado
  function saveCredentials(email, password, remember) {
    if (remember) {
      localStorage.setItem("rememberedEmail", email);
      localStorage.setItem("rememberedPassword", password);
      localStorage.setItem("rememberMe", "true");
    } else {
      localStorage.removeItem("rememberedEmail");
      localStorage.removeItem("rememberedPassword");
      localStorage.removeItem("rememberMe");
    }
  }

  // Función para cargar las credenciales guardadas
  function loadSavedCredentials() {
    const rememberedEmail = localStorage.getItem("rememberedEmail");
    const rememberedPassword = localStorage.getItem("rememberedPassword");
    const rememberMe = localStorage.getItem("rememberMe") === "true";

    if (rememberMe && rememberedEmail && rememberedPassword) {
      document.getElementById("email").value = rememberedEmail;
      document.getElementById("password").value = rememberedPassword;
      document.getElementById("remember").checked = true;
    }
  }

  // Función para verificar si hay una sesión activa
  function checkActiveSession() {
    const usuario = sessionStorage.getItem("usuario");
    const rememberMe = localStorage.getItem("rememberMe") === "true";
    
    // Si hay una sesión activa o está marcado "recordarme"
    if (usuario || rememberMe) {
      const rememberedEmail = localStorage.getItem("rememberedEmail");
      const rememberedPassword = localStorage.getItem("rememberedPassword");
      
      // Si hay credenciales guardadas, hacer login automático
      if (rememberMe && rememberedEmail && rememberedPassword && !usuario) {
        autoLogin(rememberedEmail, rememberedPassword);
        return;
      }
      
      // Si ya hay una sesión activa, redirigir
      if (usuario) {
        window.location.href = "index.html";
        return;
      }
    }
  }

  // Función para login automático
  async function autoLogin(email, password) {
    try {
      toggleLoading(true);
      
      const resUsers = await fetch("https://healtyapi.bsite.net/api/users");
      const users = await resUsers.json();

      const user = users.find(u => u.email === email && u.password === password);

      if (user && (!user.RoleInfo || user.RoleInfo.id_rol !== 3)) {
        sessionStorage.setItem("usuario", JSON.stringify(user));
        window.location.href = "index.html";
      } else {
        // Si las credenciales guardadas no son válidas, eliminarlas
        localStorage.removeItem("rememberedEmail");
        localStorage.removeItem("rememberedPassword");
        localStorage.removeItem("rememberMe");
        toggleLoading(false);
      }
    } catch (error) {
      console.error("Error en login automático:", error);
      toggleLoading(false);
    }
  }

  // Función principal de login
  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const remember = document.getElementById("remember").checked;
    const errorDiv = document.getElementById("login-error");
    
    errorDiv.style.display = "none";
    errorDiv.innerText = "";

    // Verifica si los campos están completos
    if (!email || !password) {
      errorDiv.innerText = "Completa todos los campos.";
      errorDiv.style.display = "block";
      return;
    }

    // Verifica que el correo tenga el dominio correcto
    if (!email.endsWith("@uttn.mx")) {
      errorDiv.innerText = "Solo se permiten correos institucionales @uttn.mx";
      errorDiv.style.display = "block";
      return;
    }

    toggleLoading(true);

    try {
      // Obtener todos los usuarios desde la API
      const resUsers = await fetch("https://healtyapi.bsite.net/api/users");
      const users = await resUsers.json();

      console.log("Usuarios desde API:", users);
      console.log("Email ingresado:", email);
      console.log("Password ingresada:", password);

      // Buscar al usuario con el correo y la contraseña proporcionados
      const user = users.find(u => u.email === email && u.password === password);

      // Si no se encuentra el usuario o la contraseña es incorrecta
      if (!user) {
        console.warn("Usuario no encontrado o contraseña incorrecta.");
        errorDiv.innerText = "Credenciales inválidas.";
        errorDiv.style.display = "block";
        toggleLoading(false);
        return;
      }

      // Verifica si el rol del usuario es 'alumno' (id_rol === 3)
      if (user.RoleInfo && user.RoleInfo.id_rol === 3) {
        errorDiv.innerText = "Acceso no permitido para estudiantes.";
        errorDiv.style.display = "block";
        toggleLoading(false);
        return;
      }

      // Guarda las credenciales si "Recordarme" está marcado
      saveCredentials(email, password, remember);

      // Guarda los datos del usuario en la sesión y redirige
      sessionStorage.setItem("usuario", JSON.stringify(user));
      
      // Pequeña pausa para mostrar la animación antes de redirigir
      setTimeout(() => {
        window.location.href = "index.html";
      }, 500);

    } catch (error) {
      console.error("Error al conectar con el servidor:", error);
      errorDiv.innerText = "Error al conectar con el servidor.";
      errorDiv.style.display = "block";
      toggleLoading(false);
    }
  }

  // Event listeners
  document.addEventListener("DOMContentLoaded", function() {
    // Verificar sesión activa al cargar la página
    checkActiveSession();
    
    // Cargar credenciales guardadas
    loadSavedCredentials();

    // Agregar event listener para el formulario (Enter)
    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault();
      login();
    });

    // Event listener para presionar Enter en los campos de input
    document.getElementById("email").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        login();
      }
    });

    document.getElementById("password").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        login();
      }
    });
  });

  // Función para cerrar sesión (puedes llamarla desde otras páginas)
  function logout() {
    sessionStorage.removeItem("usuario");
    // No eliminar las credenciales guardadas a menos que el usuario desmarque "recordarme"
    window.location.href = "login.html";
  }
</script>

</body>
</html>