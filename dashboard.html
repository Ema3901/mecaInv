<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Administrativo - Sistema de Inventario</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <link href="css/style.css" rel="stylesheet" />
  <link href="css/dashboard.css" rel="stylesheet" />

</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header" title="Menú">
        Inventario
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="index.html"><i class="fas fa-cubes"></i> <span>Inventario</span></a></li>
          <li><a href="deleteItems.html"><i class="fas fa-archive"></i> <span>Desactivados</span></a></li>
          <li><a href="pendientesCheck.html"><i class="fas fa-exclamation-circle"></i> <span>Pendientes Check</span></a></li>
          <li><a href="historial.html"><i class="fas fa-history"></i> <span>Historial</span></a></li>
          <li><a href="productosOcupados.html"><i class="fas fa-user-clock"></i> <span>Ocupados</span></a></li>
          <li><a href="excel.html"><i class="fas fa-download"></i> <span>Descargar tablas</span></a></li>
          <li><a href="dashboard.html" class="active"><i class="fas fa-shield-alt"></i> <span>Panel administrativo</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="main-header d-flex align-items-center justify-content-between flex-wrap">
        <h1 id="page-title">Dashboard Administrativo</h1>
        <div class="user-box dropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="https://via.placeholder.com/40x40?text=A" alt="Admin Avatar" id="profileDropdown"/>
          <span id="admin-name">Administrador</span>
          <i class="fas fa-chevron-down ml-2"></i>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
            <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión</a></li>
          </ul>
        </div>
      </header>

      <div class="divider"></div>

      <!-- Dashboard Section -->
      <div id="dashboard-section" class="section-content active">
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-card stats-card">
              <span class="stats-number" id="total-users">-</span>
              <span class="stats-label">Usuarios Totales</span>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-card stats-card">
              <span class="stats-number" id="total-students">-</span>
              <span class="stats-label">Estudiantes</span>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-card stats-card">
              <span class="stats-number" id="total-brands">-</span>
              <span class="stats-label">Marcas</span>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-card stats-card">
              <span class="stats-number" id="total-laboratories">-</span>
              <span class="stats-label">Laboratorios</span>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <h4><i class="fas fa-chart-line me-2"></i>Dashboard Administrativo</h4>
          <p>Bienvenido al panel administrativo del sistema de inventario. Desde aquí puedes gestionar todos los aspectos del sistema.</p>
          <div class="row">
            <div class="col-md-12">
              <h6>Gestión de Entidades</h6>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="showSection('users')">
                  <i class="fas fa-users me-1"></i>Usuarios
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="showSection('students')">
                  <i class="fas fa-user-graduate me-1"></i>Estudiantes
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showSection('brands')">
                  <i class="fas fa-tags me-1"></i>Marcas
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="showSection('categories')">
                  <i class="fas fa-list me-1"></i>Categorías
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="showSection('areas')">
                  <i class="fas fa-map-marker-alt me-1"></i>Áreas
                </button>
                <button class="btn btn-outline-dark btn-sm" onclick="showSection('locations')">
                  <i class="fas fa-location-arrow me-1"></i>Ubicaciones
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="showSection('laboratories')">
                  <i class="fas fa-flask me-1"></i>Laboratorios
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="users-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Usuarios</h3>
          <button class="btn btn-success" onclick="openAddUserModal()">
            <i class="fas fa-plus me-2"></i>Nuevo Usuario
          </button>
        </div>

        <div class="admin-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex gap-2">
              <input type="text" class="form-control" id="user-search" placeholder="Buscar usuarios..." style="width: 300px;">
            </div>
            <button class="btn btn-outline-secondary" onclick="loadUsers()">
              <i class="fas fa-sync me-1"></i>Actualizar
            </button>
          </div>
          
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td colspan="5" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando usuarios...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Students Section -->
      <div id="students-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Estudiantes</h3>
          <button class="btn btn-success" onclick="openAddStudentModal()">
            <i class="fas fa-plus me-2"></i>Nuevo Estudiante
          </button>
        </div>

        <div class="admin-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex gap-2">
              <input type="text" class="form-control" id="student-search" placeholder="Buscar estudiantes..." style="width: 300px;">
            </div>
            <button class="btn btn-outline-secondary" onclick="loadStudents()">
              <i class="fas fa-sync me-1"></i>Actualizar
            </button>
          </div>
          
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Grado</th>
                  <th>Grupo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="students-table-body">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando estudiantes...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Brands Section -->
      <div id="brands-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Marcas</h3>
          <button class="btn btn-success" onclick="openAddBrandModal()">
            <i class="fas fa-plus me-2"></i>Nueva Marca
          </button>
        </div>

        <div class="admin-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <input type="text" class="form-control" id="brand-search" placeholder="Buscar marcas..." style="width: 300px;">
            <button class="btn btn-outline-secondary" onclick="loadBrands()">
              <i class="fas fa-sync me-1"></i>Actualizar
            </button>
          </div>
          
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="brands-table-body">
                <tr>
                  <td colspan="4" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando marcas...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Categories Section -->
      <div id="categories-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Categorías</h3>
          <button class="btn btn-success" onclick="openAddCategoryModal()">
            <i class="fas fa-plus me-2"></i>Nueva Categoría
          </button>
        </div>

        <div class="admin-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <input type="text" class="form-control" id="category-search" placeholder="Buscar categorías..." style="width: 300px;">
            <button class="btn btn-outline-secondary" onclick="loadCategories()">
              <i class="fas fa-sync me-1"></i>Actualizar
            </button>
          </div>
          
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="categories-table-body">
                <tr>
                  <td colspan="4" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando categorías...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Areas Section -->
      <div id="areas-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Áreas</h3>
          <button class="btn btn-success" onclick="openAddAreaModal()">
            <i class="fas fa-plus me-2"></i>Nueva Área
          </button>
        </div>

        <div class="admin-card">
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="areas-table-body">
                <tr>
                  <td colspan="4" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando áreas...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Locations Section -->
      <div id="locations-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Ubicaciones</h3>
          <button class="btn btn-success" onclick="openAddLocationModal()">
            <i class="fas fa-plus me-2"></i>Nueva Ubicación
          </button>
        </div>

        <div class="admin-card">
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="locations-table-body">
                <tr>
                  <td colspan="4" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando ubicaciones...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Laboratories Section -->
      <div id="laboratories-section" class="section-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gestión de Laboratorios</h3>
          <button class="btn btn-success" onclick="openAddLaboratoryModal()">
            <i class="fas fa-plus me-2"></i>Nuevo Laboratorio
          </button>
        </div>

        <div class="admin-card">
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="laboratories-table-body">
                <tr>
                  <td colspan="4" class="text-center">
                    <div class="loading">
                      <div class="spinner-border spinner-border-custom" role="status"></div>
                      <p>Cargando laboratorios...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalTitle">Nuevo Usuario</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <input type="hidden" id="userId">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-control" id="userName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="userEmail" required>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Contraseña *</label>
                <div class="password-field">
                  <input type="password" class="form-control" id="userPassword" required>
                  <i class="fas fa-eye password-toggle" onclick="togglePassword('userPassword')"></i>
                </div>
                <small class="text-muted">Mínimo 8 caracteres, incluya mayúsculas, minúsculas y números</small>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="saveUser()">Guardar Usuario</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Modal -->
  <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentModalTitle">Nuevo Estudiante</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="studentForm">
            <input type="hidden" id="studentId">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-control" id="studentName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="studentEmail" required>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="saveStudent()">Guardar Estudiante</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Modal for Brands, Categories, etc. -->
  <div class="modal fade" id="genericModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="genericModalTitle">Nuevo Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="genericForm">
            <input type="hidden" id="genericId">
            <input type="hidden" id="genericType">
            <div class="mb-3">
              <label class="form-label">Nombre *</label>
              <input type="text" class="form-control" id="genericName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" id="genericDescription" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="saveGeneric()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirmar Acción</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
            <p id="confirmMessage">¿Está seguro de que desea realizar esta acción?</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmButton" onclick="executeConfirmedAction()">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/session-manager.js"></script>

  <script>
    // Configuration
    const API_BASE_URL = 'https://healtyapi.bsite.net/api';
    let currentUser = null;
    let confirmAction = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      initializeNavigation();
      loadDashboardData();
    });

    // Navigation
    function initializeNavigation() {
      // Set initial active state
      document.querySelector('.sidebar .sidebar-nav a[href="dashboard.html"]').classList.add('active');
    }

    function showSection(sectionName) {
      // Update navigation
      document.querySelectorAll('.sidebar .sidebar-nav a').forEach(link => {
        link.classList.remove('active');
      });
      
      // Find and activate the correct navigation link
      document.querySelectorAll('.sidebar .sidebar-nav a').forEach(link => {
        if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(sectionName)) {
          link.classList.add('active');
        }
      });

      // Update content
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${sectionName}-section`).classList.add('active');

      // Update page title
      const titles = {
        dashboard: 'Dashboard Administrativo',
        users: 'Gestión de Usuarios',
        students: 'Gestión de Estudiantes',
        brands: 'Gestión de Marcas',
        categories: 'Gestión de Categorías',
        areas: 'Gestión de Áreas',
        locations: 'Gestión de Ubicaciones',
        laboratories: 'Gestión de Laboratorios'
      };
      document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

      // Load section data
      switch(sectionName) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'users':
          loadUsers();
          break;
        case 'students':
          loadStudents();
          break;
        case 'brands':
          loadBrands();
          break;
        case 'categories':
          loadCategories();
          break;
        case 'areas':
          loadAreas();
          break;
        case 'locations':
          loadLocations();
          break;
        case 'laboratories':
          loadLaboratories();
          break;
      }
    }

    // API calls
    async function apiCall(endpoint, method = 'GET', data = null) {
      try {
        const options = {
          method,
          headers: {
            'Content-Type': 'application/json',
          }
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Check if response has content before parsing JSON
        const text = await response.text();
        if (text) {
          return JSON.parse(text);
        }
        return null;
      } catch (error) {
        console.error('API call error:', error);
        showAlert(`Error en la operación: ${error.message}`, 'danger');
        return null;
      }
    }

    // Dashboard data loading
    async function loadDashboardData() {
      try {
        const [users, students, brands, laboratories] = await Promise.all([
          apiCall('/users'),
          apiCall('/students'),
          apiCall('/brands'),
          apiCall('/laboratories')
        ]);

        document.getElementById('total-users').textContent = users ? users.length : '0';
        document.getElementById('total-students').textContent = students ? students.length : '0';
        document.getElementById('total-brands').textContent = brands ? brands.length : '0';
        document.getElementById('total-laboratories').textContent = laboratories ? laboratories.length : '0';
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('total-users').textContent = '0';
        document.getElementById('total-students').textContent = '0';
        document.getElementById('total-brands').textContent = '0';
        document.getElementById('total-laboratories').textContent = '0';
      }
    }

    // Users management
    async function loadUsers() {
      const tbody = document.getElementById('users-table-body');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="loading"><div class="spinner-border spinner-border-custom" role="status"></div><p>Cargando usuarios...</p></div></td></tr>';

      const users = await apiCall('/users');
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No se encontraron usuarios</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.id_user || user.id}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.RoleInfo ? user.RoleInfo.rol : 'N/A'}</td>
          <td>
            <button class="btn btn-action btn-edit" onclick="editUser(${user.id_user || user.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-action btn-delete" onclick="deleteUser(${user.id_user || user.id})" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function openAddUserModal() {
      document.getElementById('userModalTitle').textContent = 'Nuevo Usuario';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    async function editUser(id) {
      const user = await apiCall(`/users/${id}`);
      if (!user) return;

      document.getElementById('userModalTitle').textContent = 'Editar Usuario';
      document.getElementById('userId').value = user.id_user || user.id;
      document.getElementById('userName').value = user.name;
      document.getElementById('userEmail').value = user.email;
      
      // Make password optional for editing
      document.getElementById('userPassword').required = false;
      
      new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    async function saveUser() {
      const form = document.getElementById('userForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const userId = document.getElementById('userId').value;
      const password = document.getElementById('userPassword').value;

      if (!userId && (!password || password.length < 8)) {
        showAlert('La contraseña debe tener al menos 8 caracteres', 'danger');
        return;
      }

      const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value
      };

      if (password) {
        userData.password = password;
      }

      const endpoint = '/users';
      const method = userId ? 'PUT' : 'POST';
      
      if (userId) {
        userData.id_user = parseInt(userId);
      }

      const result = await apiCall(endpoint, method, userData);
      if (result !== null) {
        showAlert(`Usuario ${userId ? 'actualizado' : 'creado'} exitosamente`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUsers();
      }
    }

    function deleteUser(id) {
      confirmAction = () => executeDeleteUser(id);
      document.getElementById('confirmMessage').textContent = '¿Está seguro de que desea eliminar este usuario? Esta acción no se puede deshacer.';
      new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }

    async function executeDeleteUser(id) {
      const result = await apiCall(`/user/Delete?id=${id}`, 'POST');
      if (result !== null) {
        showAlert('Usuario eliminado exitosamente', 'success');
        loadUsers();
      }
    }

    // Students management
    async function loadStudents() {
      const tbody = document.getElementById('students-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="loading"><div class="spinner-border spinner-border-custom" role="status"></div><p>Cargando estudiantes...</p></div></td></tr>';

      const students = await apiCall('/students');
      if (!students || students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron estudiantes</td></tr>';
        return;
      }

      tbody.innerHTML = students.map(student => `
        <tr>
          <td>${student.id_student || student.id}</td>
          <td>${student.student_name || student.name}</td>
          <td>${student.email || 'N/A'}</td>
          <td>${student.GradeInfo ? student.GradeInfo.grade : 'N/A'}</td>
          <td>${student.GroupInfo ? student.GroupInfo.group_name : 'N/A'}</td>
          <td>
            <button class="btn btn-action btn-edit" onclick="editStudent(${student.id_student || student.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-action btn-delete" onclick="deleteStudent(${student.id_student || student.id})" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function openAddStudentModal() {
      document.getElementById('studentModalTitle').textContent = 'Nuevo Estudiante';
      document.getElementById('studentForm').reset();
      document.getElementById('studentId').value = '';
      new bootstrap.Modal(document.getElementById('studentModal')).show();
    }

    async function editStudent(id) {
      const student = await apiCall(`/students/${id}`);
      if (!student) return;

      document.getElementById('studentModalTitle').textContent = 'Editar Estudiante';
      document.getElementById('studentId').value = student.id_student || student.id;
      document.getElementById('studentName').value = student.student_name || student.name;
      document.getElementById('studentEmail').value = student.email || '';
      
      new bootstrap.Modal(document.getElementById('studentModal')).show();
    }

    async function saveStudent() {
      const form = document.getElementById('studentForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const studentId = document.getElementById('studentId').value;
      const studentData = {
        student_name: document.getElementById('studentName').value,
        email: document.getElementById('studentEmail').value
      };

      const endpoint = '/students';
      const method = studentId ? 'PUT' : 'POST';
      
      if (studentId) {
        studentData.id_student = parseInt(studentId);
      }

      const result = await apiCall(endpoint, method, studentData);
      if (result !== null) {
        showAlert(`Estudiante ${studentId ? 'actualizado' : 'creado'} exitosamente`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
        loadStudents();
      }
    }

    function deleteStudent(id) {
      confirmAction = () => executeDeleteStudent(id);
      document.getElementById('confirmMessage').textContent = '¿Está seguro de que desea eliminar este estudiante? Esta acción no se puede deshacer.';
      new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }

    async function executeDeleteStudent(id) {
      const result = await apiCall(`/students/Delete?id=${id}`, 'POST');
      if (result !== null) {
        showAlert('Estudiante eliminado exitosamente', 'success');
        loadStudents();
      }
    }

    // Generic CRUD operations for simple entities
    async function loadGenericData(entity, tableBodyId) {
      const tbody = document.getElementById(tableBodyId);
      tbody.innerHTML = `<tr><td colspan="4" class="text-center"><div class="loading"><div class="spinner-border spinner-border-custom" role="status"></div><p>Cargando ${entity}...</p></div></td></tr>`;

      const endpoint = entity === 'locations' ? '/location_' : 
                      entity === 'areas' ? '/areas' :
                      `/${entity}`;
      
      const data = await apiCall(endpoint);
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center">No se encontraron ${entity}</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(item => `
        <tr>
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.description || 'Sin descripción'}</td>
          <td>
            <button class="btn btn-action btn-edit" onclick="editGenericItem('${entity}', ${item.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-action btn-delete" onclick="deleteGenericItem('${entity}', ${item.id})" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Specific load functions
    async function loadBrands() { await loadGenericData('brands', 'brands-table-body'); }
    async function loadCategories() { await loadGenericData('categories', 'categories-table-body'); }
    async function loadAreas() { await loadGenericData('areas', 'areas-table-body'); }
    async function loadLocations() { await loadGenericData('locations', 'locations-table-body'); }
    async function loadLaboratories() { await loadGenericData('laboratories', 'laboratories-table-body'); }

    // Generic modal functions
    function openGenericModal(type, title) {
      document.getElementById('genericModalTitle').textContent = `Nueva ${title}`;
      document.getElementById('genericType').value = type;
      document.getElementById('genericForm').reset();
      document.getElementById('genericId').value = '';
      new bootstrap.Modal(document.getElementById('genericModal')).show();
    }

    // Specific add functions
    function openAddBrandModal() { openGenericModal('brands', 'Marca'); }
    function openAddCategoryModal() { openGenericModal('categories', 'Categoría'); }
    function openAddAreaModal() { openGenericModal('areas', 'Área'); }
    function openAddLocationModal() { openGenericModal('locations', 'Ubicación'); }
    function openAddLaboratoryModal() { openGenericModal('laboratories', 'Laboratorio'); }

    async function editGenericItem(type, id) {
      const endpoint = type === 'locations' ? '/location_' : 
                      type === 'areas' ? '/areas' :
                      `/${type}`;
      
      const item = await apiCall(`${endpoint}/${id}`);
      if (!item) return;

      const titles = {
        brands: 'Marca',
        categories: 'Categoría',
        areas: 'Área',
        locations: 'Ubicación',
        laboratories: 'Laboratorio'
      };

      document.getElementById('genericModalTitle').textContent = `Editar ${titles[type]}`;
      document.getElementById('genericType').value = type;
      document.getElementById('genericId').value = item.id;
      document.getElementById('genericName').value = item.name;
      document.getElementById('genericDescription').value = item.description || '';
      new bootstrap.Modal(document.getElementById('genericModal')).show();
    }

    async function saveGeneric() {
      const form = document.getElementById('genericForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const type = document.getElementById('genericType').value;
      const id = document.getElementById('genericId').value;
      const data = {
        name: document.getElementById('genericName').value,
        description: document.getElementById('genericDescription').value || null
      };

      const endpoint = type === 'locations' ? '/location_' : 
                      type === 'areas' ? '/areas' :
                      `/${type}`;
      
      const method = id ? 'PUT' : 'POST';
      if (id) {
        data.id = parseInt(id);
      }

      const result = await apiCall(endpoint, method, data);
      if (result !== null) {
        const titles = {
          brands: 'Marca',
          categories: 'Categoría',
          areas: 'Área',
          locations: 'Ubicación',
          laboratories: 'Laboratorio'
        };
        showAlert(`${titles[type]} ${id ? 'actualizada' : 'creada'} exitosamente`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('genericModal')).hide();
        
        // Reload appropriate data
        switch(type) {
          case 'brands': loadBrands(); break;
          case 'categories': loadCategories(); break;
          case 'areas': loadAreas(); break;
          case 'locations': loadLocations(); break;
          case 'laboratories': loadLaboratories(); break;
        }
      }
    }

    function deleteGenericItem(type, id) {
      const titles = {
        brands: 'marca',
        categories: 'categoría',
        areas: 'área',
        locations: 'ubicación',
        laboratories: 'laboratorio'
      };
      
      confirmAction = () => executeDeleteGeneric(type, id);
      document.getElementById('confirmMessage').textContent = `¿Está seguro de que desea eliminar esta ${titles[type]}? Esta acción no se puede deshacer.`;
      new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }

    async function executeDeleteGeneric(type, id) {
      const deleteEndpoint = type === 'locations' ? '/location_/Delete?id=' : 
                            type === 'areas' ? '/area/Delete?id=' :
                            type === 'brands' ? '/brand/Delete?id=' :
                            `/${type}/Delete?id=`;
      
      const result = await apiCall(`${deleteEndpoint}${id}`, 'POST');
      if (result !== null) {
        const titles = {
          brands: 'Marca',
          categories: 'Categoría',
          areas: 'Área',
          locations: 'Ubicación',
          laboratories: 'Laboratorio'
        };
        showAlert(`${titles[type]} eliminada exitosamente`, 'success');
        
        // Reload appropriate data
        switch(type) {
          case 'brands': loadBrands(); break;
          case 'categories': loadCategories(); break;
          case 'areas': loadAreas(); break;
          case 'locations': loadLocations(); break;
          case 'laboratories': loadLaboratories(); break;
        }
      }
    }

    // Utility functions
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling;
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function showAlert(message, type = 'info') {
      // Remove existing alerts
      const existingAlert = document.querySelector('.alert-custom');
      if (existingAlert) {
        existingAlert.remove();
      }

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      // Insert after the header
      const header = document.querySelector('.main-header');
      header.parentNode.insertBefore(alertDiv, header.nextSibling);

      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function executeConfirmedAction() {
      if (confirmAction) {
        confirmAction();
        confirmAction = null;
      }
      bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    }

    function handleLogout() {
      localStorage.removeItem('adminUser');
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    // Search functionality
    document.getElementById('user-search')?.addEventListener('input', function(e) {
      filterTable('users-table-body', e.target.value, [1, 2]); // Search in name and email columns
    });

    document.getElementById('student-search')?.addEventListener('input', function(e) {
      filterTable('students-table-body', e.target.value, [1, 2]); // Search in name and email columns
    });

    document.getElementById('brand-search')?.addEventListener('input', function(e) {
      filterTable('brands-table-body', e.target.value, [1, 2]); // Search in name and description columns
    });

    document.getElementById('category-search')?.addEventListener('input', function(e) {
      filterTable('categories-table-body', e.target.value, [1, 2]); // Search in name and description columns
    });

    function filterTable(tableBodyId, searchTerm, searchColumns) {
      const tbody = document.getElementById(tableBodyId);
      const rows = tbody.querySelectorAll('tr');
      
      searchTerm = searchTerm.toLowerCase();
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let matchFound = false;
        
        searchColumns.forEach(columnIndex => {
          if (cells[columnIndex] && cells[columnIndex].textContent.toLowerCase().includes(searchTerm)) {
            matchFound = true;
          }
        });
        
        row.style.display = matchFound || searchTerm === '' ? '' : 'none';
      });
    }
  </script>
</body>
</html>