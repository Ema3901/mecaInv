<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pendientes por Check</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />
  <!-- SweetAlert2 - REQUERIDO para el JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* ESTILOS ESPECÍFICOS PARA LA PÁGINA DE PENDIENTES */
    /* Estos estilos complementan los de style.css sin sobrescribirlos */
    
    /* Ajustes específicos para la tabla de pendientes */
    #pendientesTable {
      border-collapse: separate;
      border-spacing: 0 0.75rem;
    }
    
    #pendientesTable thead {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);
      color: white;
    }
    
    #pendientesTable thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Alineación específica por columna para tabla de pendientes */
    #pendientesTable tbody td:first-child {
      text-align: center;
      font-weight: bold;
      color: var(--primary-green);
    }
    
    #pendientesTable tbody td:nth-child(2) {
      text-align: left;
      font-weight: 500;
    }
    
    #pendientesTable tbody td:nth-child(3),
    #pendientesTable tbody td:nth-child(4),
    #pendientesTable tbody td:nth-child(5),
    #pendientesTable tbody td:nth-child(6) {
      text-align: center;
    }
    
    /* Columna de etiquetado más amplia para acomodar los labels */
    #pendientesTable tbody td:nth-child(7) {
      text-align: left;
      min-width: 300px;
      max-width: 350px;
      padding: 1rem 0.75rem;
    }
    
    /* Estilos para los labels de los campos */
    .form-label.fw-semibold {
      margin-bottom: 0.25rem !important;
      font-size: 0.8rem;
      color: #6c757d !important;
    }
    
    /* Separación entre los campos de etiquetado */
    #pendientesTable tbody td:nth-child(7) > div:first-child {
      margin-bottom: 1rem;
    }
    
    /* Botones de acción */
    #pendientesTable tbody td:last-child {
      text-align: right;
      white-space: nowrap;
    }

    /* ESTILOS PARA ELEMENTOS DE LA TABLA DE PENDIENTES */
    .label-select {
      width: 100%;
      max-width: 150px;
      font-size: 0.875rem;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      background-color: white;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .label-select:focus {
      border-color: var(--primary-green);
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(26, 177, 146, 0.25);
    }
    
    .label-select option {
      font-size: 0.875rem;
    }
    
    /* Ajustes para los controles de formulario pequeños */
    .form-control-sm {
      font-size: 0.875rem;
      border-radius: 0.375rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .form-control-sm:focus {
      border-color: var(--primary-green);
      box-shadow: 0 0 0 0.2rem rgba(26, 177, 146, 0.25);
    }
    
    /* Estilos adicionales para estados específicos de pendientes */
    .alerta-check {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      color: #856404;
      display: none;
    }
    
    #mensajeFinal {
      display: none;
    }
    
    #mensajeFinal i {
      font-size: 3rem;
      color: var(--status-good);
    }

    /* Mejoras visuales para botones de pendientes */
    .completion-message {
      padding: 2rem;
    }
    
    /* Contador de pendientes estilo especial */
    #pendientes-counter td {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);
      color: white;
      font-weight: 600;
      text-align: center;
      border-radius: 0.375rem;
    }
    
    /* Botón de aprobar todos estilo especial */
    #aprobar-todos-row td {
      background-color: #f8f9fa;
      border-top: 2px solid var(--primary-green);
    }
    
    /* Ajustes para que coincida con el estilo existente */
    .btn-success {
      background-color: var(--primary-green);
      border-color: var(--primary-green);
    }
    
    .btn-success:hover {
      background-color: var(--primary-green-dark);
      border-color: var(--primary-green-dark);
    }
    
    /* Badge de estado pendiente personalizado */
    .badge.bg-warning {
      background-color: var(--status-pending) !important;
      color: #212529;
    }
    
    /* Ajustes responsive específicos para pendientes */
    @media (max-width: 768px) {
      #pendientesTable tbody td:nth-child(7) {
        min-width: 200px;
        max-width: 220px;
      }
      
      .label-select {
        max-width: 120px;
        font-size: 0.8rem;
      }
      
      .form-control-sm {
        font-size: 0.8rem;
      }
      
      .form-label.fw-semibold {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        Inventario
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="index.html"><i class="fas fa-cubes"></i> Inventario</a></li>
          <li><a href="deleteItems.html"><i class="fas fa-archive"></i> Desactivados</a></li> 
          <li><a href="pendientesCheck.html" class="active"><i class="fas fa-exclamation-circle"></i> Pendientes Check</a></li>
          <li><a href="historial.html"><i class="fas fa-history"></i> Historial</a></li>
          <li><a href="productosOcupados.html"><i class="fas fa-user-clock"></i> Ocupados</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="main-header d-flex align-items-center justify-content-between flex-wrap">
        <h1>Pendientes por Revisar</h1>
        <div class="user-box dropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="https://via.placeholder.com/40" alt="User Avatar" id="profileDropdown"/>
          <span>Ann Lee</span>
          <i class="fas fa-chevron-down ml-2"></i>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
            <li><a class="dropdown-item" href="login.html" onclick="handleLogout()">Cerrar sesión</a></li>
          </ul>
        </div>
      </header>

      <div class="divider"></div>

      <div id="alertaCheck" class="alerta-check">
        <strong>¿Seguro que apruebas TODOS los checks?</strong> Esta acción no se puede deshacer.
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-success btn-sm" onclick="confirmarAprobacion()">Sí, aprobar</button>
          <button class="btn btn-secondary btn-sm" onclick="cancelarAprobacion()">Cancelar</button>
        </div>
      </div>

      <!-- Contador de productos pendientes -->
      <div id="contadorPendientes" class="alert alert-info d-flex align-items-center mb-3" style="display: none !important;">
        <i class="fas fa-tasks me-2"></i>
        <span id="textoPendientes"><strong>Productos pendientes: 0</strong></span>
      </div>

      <div id="tablaPendientes" class="table-container mt-3">
        <table id="pendientesTable" class="table table-hover mb-0">
          <thead>
            <tr>
              <th style="width: 80px;">ID</th>
              <th style="width: 150px;">Artículo</th>
              <th style="width: 120px;">Modelo</th>
              <th style="width: 140px;">Ubicación</th>
              <th style="width: 120px;">Laboratorio</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 300px;">Etiquetado</th>
              <th style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los datos se cargan dinámicamente -->
          </tbody>
        </table>
      </div>

      <div id="mensajeFinal" class="text-center py-5">
        <i class="fas fa-check-circle mb-3"></i>
        <h2 class="text-success">Todos los productos han sido revisados,<br>nos vemos la próxima revisión</h2>
        <a href="index.html" class="btn btn-outline-primary mt-4">
          <i class="fas fa-arrow-left"></i> Regresar al inventario
        </a>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
  
  <script>
    // Sistema de Revisión Semestral de Inventario - CORREGIDO con SweetAlert
    document.addEventListener('DOMContentLoaded', async () => {
        const tbody = document.querySelector('#pendientesTable tbody');
        const API_BASE_URL = "https://healtyapi.bsite.net/api/product_units";
        
        let pendientes = []; // Array global para manejar los productos pendientes

        // Función para obtener usuario actual (placeholder)
        function getCurrentUser() {
            return localStorage.getItem('currentUser') || 'Sistema';
        }

        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // FUNCIÓN CORREGIDA: Filtrar productos pendientes
        async function obtenerProductosPendientes() {
            try {
                showNotification('Cargando productos pendientes...', 'info');
                
                const response = await fetch(API_BASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // FILTRADO: Buscar productos con PendingStatus = "Pendiente"
                pendientes = data.filter(item => {
                    const isPendiente = item.PendingStatus === "Pendiente";
                    const isActive = item.Status !== "Deshabilitado" && item.Status !== "Inactivo";
                    return isPendiente && isActive;
                });

                showNotification(`Se encontraron ${pendientes.length} productos pendientes`, 'success');
                return pendientes;
                
            } catch (error) {
                showNotification('Error al cargar los productos. Verifica tu conexión.', 'danger');
                return [];
            }
        }

        // Función para renderizar la tabla - CORREGIDA para coincidir con las columnas HTML
        function renderTabla() {
            tbody.innerHTML = '';

            if (pendientes.length === 0) {
                mostrarMensajeFinal();
                return;
            }

            pendientes.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-index', index);
                tr.setAttribute('data-id', item.id_unit);

                // Select para estado de etiqueta
                const selectLabel = createLabelSelect(item.LabelStatus, index);
                
                // Textarea para observaciones
                const textareaObs = createObservationsTextarea(item.observations || "", index);

                tr.innerHTML = `
                    <td class="fw-bold text-primary">${item.id_unit}</td>
                    <td class="text-start">${item.ProductInfo?.name || 'N/A'}</td>
                    <td><span class="badge bg-secondary">${item.ProductInfo?.model || 'N/A'}</span></td>
                    <td><i class="fas fa-map-marker-alt text-muted me-1"></i>${item.LocationInfo?.location_name || 'N/A'}</td>
                    <td><i class="fas fa-flask text-info me-1"></i>${item.LabInfo?.lab_name || 'N/A'}</td>
                    <td><span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>PENDIENTE</span></td>
                    <td class="text-start">
                        ${selectLabel}
                        ${textareaObs}
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-success shadow-sm" onclick="aprobarUno(${index})" title="Aprobar revisión">
                            <i class="fas fa-check me-1"></i> Aprobar
                        </button>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            agregarBotonAprobarTodos();
            mostrarContadorPendientes();
        }

        // Función para mostrar contador de pendientes arriba de la tabla
        function mostrarContadorPendientes() {
            const contador = document.getElementById('contadorPendientes');
            const textoPendientes = document.getElementById('textoPendientes');
            
            if (pendientes.length > 0) {
                textoPendientes.innerHTML = `<strong>Productos pendientes: ${pendientes.length}</strong>`;
                contador.style.display = 'flex';
            } else {
                contador.style.display = 'none';
            }
        }

        // Función para agregar contador de pendientes - YA NO SE USA EN LA TABLA
        function agregarContadorPendientes() {
            // Esta función ahora está vacía porque movimos el contador arriba de la tabla
        }

        // Función para agregar botón "Aprobar Todos"
        function agregarBotonAprobarTodos() {
            const existingButton = document.getElementById('aprobar-todos-row');
            if (existingButton) existingButton.remove();
            
            if (pendientes.length > 0) {
                const buttonRow = document.createElement('tr');
                buttonRow.id = 'aprobar-todos-row';
                buttonRow.innerHTML = `
                    <td colspan="8" class="bg-light text-center py-3 border-top">
                        <button class="btn btn-success btn-lg shadow" onclick="aprobarTodos()" title="Aprobar todos los productos pendientes">
                            <i class="fas fa-check-double me-2"></i>
                            Aprobar Todos los Productos (${pendientes.length})
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Esto aprobará todos los productos que tengan los campos completos
                            </small>
                        </div>
                    </td>
                `;
                tbody.appendChild(buttonRow);
            }
        }

        // Crear select de etiqueta con label
        function createLabelSelect(currentLabelStatus, index) {
            let selectedValue = currentLabelStatus;
            if (typeof currentLabelStatus === 'string') {
                switch(currentLabelStatus.toLowerCase()) {
                    case 'bien': selectedValue = 1; break;
                    case 'no': selectedValue = 2; break;
                    case 'dañada': selectedValue = 3; break;
                    default: selectedValue = parseInt(currentLabelStatus) || 1;
                }
            }
            
            return `
                <div class="mb-2">
                    <label class="form-label fw-semibold text-muted small mb-1">Estado de Etiqueta:</label>
                    <select class="form-select form-select-sm label-select" id="label-${index}">
                        <option value="1" ${selectedValue == 1 ? "selected" : ""}>✅ BIEN</option>
                        <option value="2" ${selectedValue == 2 ? "selected" : ""}>❌ NO</option>
                        <option value="3" ${selectedValue == 3 ? "selected" : ""}>🔧 DAÑADA</option>
                    </select>
                </div>
            `;
        }

        // Crear textarea de observaciones con label
        function createObservationsTextarea(observations, index) {
            return `
                <div>
                    <label class="form-label fw-semibold text-muted small mb-1">Observaciones:</label>
                    <textarea class="form-control form-control-sm" 
                              id="obs-${index}" 
                              rows="2" 
                              placeholder="Escribe observaciones aquí..."
                              maxlength="500">${observations}</textarea>
                    <small class="text-muted">Máx. 500 caracteres</small>
                </div>
            `;
        }

        // FUNCIÓN: Usar endpoint específico para aprobar
        async function aprobarUno(index) {
            try {
                const row = document.querySelector(`tr[data-index="${index}"]`);
                const selectLabel = document.getElementById(`label-${index}`);
                const textareaObs = document.getElementById(`obs-${index}`);

                // Validar campos requeridos
                if (!selectLabel.value) {
                    showNotification('Por favor completa el estado de la etiqueta', 'warning');
                    return;
                }

                // Mostrar indicador de carga
                const approveButton = row.querySelector('button');
                const originalContent = approveButton.innerHTML;
                approveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Aprobando...';
                approveButton.disabled = true;

                const productId = pendientes[index].id_unit;

                // PASO 1: Usar endpoint específico para cambiar estado a "Realizado"
                const statusResponse = await fetch(`${API_BASE_URL}/set-pending-to-done/${productId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                if (!statusResponse.ok) {
                    throw new Error(`Error al cambiar estado: ${statusResponse.status}`);
                }

                // PASO 2: Actualizar otros campos
                const updatedProduct = {
                    ...pendientes[index],
                    PendingStatus: "Realizado",
                    LabelStatus: parseInt(selectLabel.value),
                    observations: textareaObs.value.trim() || null,
                    last_review_date: new Date().toISOString(),
                    reviewed_by: getCurrentUser()
                };

                const updateResponse = await fetch(`${API_BASE_URL}/${productId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(updatedProduct)
                });

                if (!updateResponse.ok) {
                    // Si falla la actualización de campos, revertir el estado
                    await fetch(`${API_BASE_URL}/set-done-to-pending/${productId}`, {
                        method: "PUT"
                    });
                    throw new Error(`Error al actualizar campos: ${updateResponse.status}`);
                }

                // Remover de la lista local y rerender
                pendientes.splice(index, 1);
                showNotification(`Producto ${productId} aprobado exitosamente`, 'success');
                renderTabla();

            } catch (error) {
                showNotification('Error al aprobar el producto. Intenta nuevamente.', 'danger');
                
                // Restaurar botón
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    const approveButton = row.querySelector('button');
                    approveButton.innerHTML = '<i class="fas fa-check me-1"></i> Aprobar';
                    approveButton.disabled = false;
                }
            }
        }

        // Función para aprobar todos los productos con SweetAlert
        async function aprobarTodos() {
            if (pendientes.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin productos pendientes',
                    text: 'No hay productos pendientes para aprobar',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            // Verificar que todos los productos tengan campos completos
            const productosIncompletos = [];
            pendientes.forEach((producto, index) => {
                const selectLabel = document.getElementById(`label-${index}`);
                
                if (!selectLabel?.value) {
                    productosIncompletos.push(producto.id_unit);
                }
            });

            if (productosIncompletos.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    html: `
                        <p>Los siguientes productos tienen campos sin completar:</p>
                        <div class="alert alert-warning mt-2">
                            <strong>Productos:</strong> ${productosIncompletos.join(', ')}
                        </div>
                        <p>Por favor, completa el <strong>estado de la etiqueta</strong> para todos los productos antes de continuar.</p>
                    `,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#f39c12'
                });
                return;
            }

            // Mostrar confirmación con detalles
            const result = await Swal.fire({
                icon: 'question',
                title: '¿Aprobar todos los productos?',
                html: `
                    <div class="text-start">
                        <p><strong>Estás a punto de aprobar ${pendientes.length} productos:</strong></p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Esto marcará todos los productos como <strong>"Realizado"</strong> y los removerá de la lista de pendientes.
                        </div>
                        <p><strong>¿Estás seguro de continuar?</strong></p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: `<i class="fas fa-check me-1"></i> Sí, aprobar todos`,
                cancelButtonText: `<i class="fas fa-times me-1"></i> Cancelar`,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#dc3545',
                focusCancel: true,
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // Mostrar progress con SweetAlert
            Swal.fire({
                title: 'Aprobando productos...',
                html: `
                    <div class="text-center">
                        <div class="mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                        </div>
                        <p id="progress-text">Iniciando proceso...</p>
                        <div class="progress mt-3">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 0%"></div>
                        </div>
                    </div>
                `,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });

            try {
                const productosParaAprobar = [...pendientes];
                const totalProductos = productosParaAprobar.length;
                let productosAprobados = 0;

                for (let i = 0; i < productosParaAprobar.length; i++) {
                    const producto = productosParaAprobar[i];
                    
                    // Actualizar progress
                    const progreso = Math.round(((i + 1) / totalProductos) * 100);
                    document.getElementById('progress-text').textContent = 
                        `Aprobando producto ${producto.id_unit} (${i + 1}/${totalProductos})`;
                    document.getElementById('progress-bar').style.width = `${progreso}%`;

                    try {
                        await aprobarUno(0);
                        productosAprobados++;
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        console.error('Error aprobando producto:', error);
                    }
                }

                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: '¡Aprobación completada!',
                    html: `
                        <div class="text-center">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Se aprobaron <strong>${productosAprobados}</strong> productos exitosamente
                            </div>
                            <p>Todos los productos han sido marcados como <strong>"Realizado"</strong></p>
                        </div>
                    `,
                    confirmButtonText: 'Excelente',
                    confirmButtonColor: '#28a745'
                });

            } catch (error) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error inesperado',
                    text: `Ocurrió un error durante el proceso: ${error.message}`,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        function mostrarMensajeFinal() {
            const trMensaje = document.createElement('tr');
            trMensaje.id = "rowMensajeFinal";
            trMensaje.innerHTML = `
                <td colspan="8" class="text-center py-5">
                    <div class="completion-message">
                        <i class="fas fa-check-circle mb-3 text-success" style="font-size: 4rem;"></i>
                        <h3 class="text-success mt-3 mb-2">¡Revisión Completada!</h3>
                        <p class="text-muted mb-4">Todos los productos han sido revisados exitosamente.</p>
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            <a href="index.html" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-1"></i> Regresar al Inventario
                            </a>
                            <button class="btn btn-outline-success" onclick="generarReporte()">
                                <i class="fas fa-file-alt me-1"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(trMensaje);
        }

        function generarReporte() {
            showNotification('Generando reporte de revisión...', 'info');
        }

        // Hacer funciones disponibles globalmente
        window.aprobarUno = aprobarUno;
        window.aprobarTodos = aprobarTodos;
        window.generarReporte = generarReporte;

        // Función de inicialización
        async function inicializar() {
            try {
                await obtenerProductosPendientes();
                renderTabla();
            } catch (error) {
                showNotification('Error al inicializar el sistema', 'danger');
                console.error('Error inicializando:', error);
            }
        }

        // Inicializar el sistema
        inicializar();
    });

    // Función placeholder para logout
    function handleLogout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
    }
  </script>
</body>
</html>